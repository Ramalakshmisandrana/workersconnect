{% extends "base.html" %}

{% block title %}Search Workers - WorkersConnect{% endblock %}

{% block content %}
<div class="search-container">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg dashboard-navbar fixed-top">
        <div class="container-fluid">

            <a class="navbar-brand" href="{{ url_for('index') }}">
                WorkersConnect
            </a>

            <button class="navbar-toggler" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#navbarNav">

                <span class="navbar-toggler-icon"></span>

            </button>


            <div class="collapse navbar-collapse justify-content-end"
                 id="navbarNav">

                <ul class="navbar-nav align-items-center">

                    {% if current_user.is_authenticated %}

                        <li class="nav-item me-2">
                            <a class="nav-link"
                               href="{{ url_for('dashboard') }}">

                                <i class="fas fa-arrow-left me-1"></i>
                                Dashboard
                            </a>
                        </li>


                        <li class="nav-item">
                            <a class="btn btn-logout"
                               href="{{ url_for('logout') }}">
                                Logout
                            </a>
                        </li>

                    {% else %}

                        <li class="nav-item">
                            <a class="nav-link"
                               href="{{ url_for('login') }}">
                                Login
                            </a>
                        </li>


                        <li class="nav-item">
                            <a class="btn btn-register"
                               href="{{ url_for('register') }}">
                                Register
                            </a>
                        </li>

                    {% endif %}

                </ul>

            </div>
        </div>
    </nav>


    <!-- Header -->
    <div class="search-header">

        <h1 class="search-title">

            {% if skill_filter %}
                {{ skill_filter }}s Near You
            {% else %}
                Available Workers Near You
            {% endif %}

        </h1>


        <p class="search-subtitle">

            {% if workers %}
                Found {{ workers|length }} skilled worker{{ 's' if workers|length != 1 else '' }}
            {% else %}
                No workers available
            {% endif %}

        </p>

    </div>


    <!-- Workers Grid -->
    {% if workers %}

    <div class="workers-grid">

        {% for worker, distance in workers %}

        <div class="worker-card"
             style="animation-delay: {{ loop.index0 * 0.1 }}s">


            <!-- Header -->
            <div class="worker-card-header">

                <div class="worker-avatar">

                    {% if worker.profile_pic %}

                        <img src="{{ worker.get_profile_pic_url() }}"
                             alt="{{ worker.full_name }}">

                    {% else %}

                        {{ worker.full_name[0].upper() }}

                    {% endif %}

                </div>


                <div class="availability-badge">
                    <i class="fas fa-circle"></i>
                    Available
                </div>

            </div>


            <!-- Name -->
            <h3 class="worker-name">
                {{ worker.full_name }}
            </h3>


            <!-- Skills -->
            <div class="worker-skills">

                {% for skill in worker.get_skills_list()[:3] %}

                    <span class="skill-tag">
                        {{ skill }}
                    </span>

                {% endfor %}

            </div>


            <!-- Info -->
            <div class="worker-info">

                <div class="info-item">

                    <i class="fas fa-briefcase"></i>
                    <span>{{ worker.experience }} yrs exp</span>

                </div>


                <div class="info-item rating-stars">

                    {% for i in range(5) %}

                        {% if i < worker.rating|int %}
                            <i class="fas fa-star"></i>

                        {% elif i < worker.rating %}
                            <i class="fas fa-star-half-alt"></i>

                        {% else %}
                            <i class="far fa-star"></i>

                        {% endif %}

                    {% endfor %}

                    <span class="text-muted ms-1">
                        ({{ "%.1f"|format(worker.rating) }})
                    </span>

                </div>

            </div>


            <!-- Distance -->
            {% if distance is not none %}

            <div class="distance-badge">

                <i class="fas fa-map-marker-alt"></i>
                {{ "%.1f"|format(distance) }} km away

            </div>

            {% endif %}


            <!-- Contact -->
            <div class="contact-buttons">


                <!-- Call -->
                <a href="tel:{{ worker.phone }}"
                   class="btn-call">

                    <i class="fas fa-phone-alt"></i>
                    Call

                </a>


                <!-- WhatsApp Icon -->
                <a href="#"
                   class="whatsapp-icon"
                   title="Chat on WhatsApp"
                   onclick="openWhatsApp('{{ worker.phone }}')">

                    <i class="fab fa-whatsapp"></i>

                </a>


            </div>

        </div>

        {% endfor %}

    </div>


    <!-- No Results -->
    {% else %}

    <div class="no-results">

        <div class="no-results-icon">
            <i class="fas fa-search"></i>
        </div>


        <h3>No Workers Found</h3>

        <p>No available workers in this area.</p>


        <a href="{{ url_for('dashboard') }}"
           class="btn btn-primary">

            <i class="fas fa-arrow-left me-2"></i>
            Go Back

        </a>

    </div>

    {% endif %}

</div>



<!-- Custom Styles -->
<style>

/* Fix Avatar Image */
.worker-avatar img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}


/* Contact Layout */
.contact-buttons{
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 15px;
}


/* WhatsApp Icon */
.whatsapp-icon{
    width: 42px;
    height: 42px;
    background: #25D366;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    font-size: 20px;
    transition: all 0.3s ease;
}


.whatsapp-icon:hover{
    background: #1ebd5a;
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(37,211,102,0.4);
    color: white;
}

</style>



<!-- WhatsApp Logic (Smart Country Code Fix) -->
<script>

function openWhatsApp(phone){

    // Remove spaces, dashes, +
    phone = phone.replace(/\s|-/g, '').replace('+','');

    // Add India code only if missing
    if(!phone.startsWith("91")){
        phone = "91" + phone;
    }

    // Try Desktop/Mobile App
    window.location.href =
        "whatsapp://send?phone=" + phone;

    // Fallback to Web
    setTimeout(function(){

        window.open(
            "https://wa.me/" + phone,
            "_blank"
        );

    }, 900);
}

</script>

{% endblock %}